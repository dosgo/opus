package: libopus
subpackage: true
vcs: https://gitlab.xiph.org/xiph/opus.git
branch: 'v1.4'
root: .
out: ./libopus
int_size: 8
ptr_size: 8
use_go_int: true
include:
  - './include'
  - './celt'
  - './silk'
  - './silk/float'
predef: |
  // TODO
define:
  - name: USE_ALLOCA
  - name: OPUS_BUILD
  - name: ALLOC_NONE
    value: '1'
  - name: alloca
    value: malloc
  - name: opus_alloc
    value: malloc
  - name: opus_free
    value: free
  # TODO: add to cxgo
  - name: HAVE_STDINT_H
  - name: __STDC__
    value: '1'
  - name: __STDC_VERSION__
    value: '199901'
idents:
  - name: ec_ctx
    fields:
      - name: buf
        type: slice
  - name: silk_NLSF_CB_struct
    fields:
      - name: CB1_NLSF_Q8
        type: slice
      - name: CB1_Wght_Q9
        type: slice
      - name: CB1_iCDF
        type: slice
      - name: pred_Q8
        type: slice
      - name: ec_sel
        type: slice
      - name: ec_iCDF
        type: slice
      - name: ec_Rates_Q5
        type: slice
      - name: deltaMin_Q15
        type: slice
  - name: silk_encoder_state
    fields:
      - name: pitch_lag_low_bits_iCDF
        type: slice
      - name: pitch_contour_iCDF
        type: slice
  - name: silk_decoder_state
    fields:
      - name: pitch_lag_low_bits_iCDF
        type: slice
      - name: pitch_contour_iCDF
        type: slice
  - name: _silk_resampler_state_struct
    fields:
      - name: Coefs
        type: slice
  - name: DenseLayer
    fields:
      - name: bias
        type: slice
      - name: input_weights
        type: slice
  - name: GRULayer
    fields:
      - name: bias
        type: slice
      - name: input_weights
        type: slice
      - name: recurrent_weights
        type: slice
  - name: compute_dense
    fields:
      - name: output
        type: slice
      - name: input
        type: slice
  - name: compute_gru
    fields:
      - name: state
        type: slice
      - name: input
        type: slice
  - name: gemm_accum
    fields:
      - name: out
        type: slice
      - name: weights
        type: slice
      - name: x
        type: slice
  - name: ec_get_buffer
    fields:
      - name: return
        type: slice
  - name: celt_maxabs16
    fields:
      - name: x
        type: slice
  - name: is_digital_silence
    fields:
      - name: pcm
        type: slice
  - name: compute_frame_energy
    fields:
      - name: pcm
        type: slice
  - name: celt_inner_prod_c
    fields:
      - name: x
        type: slice
      - name: y
        type: slice
  - name: xcorr_kernel_c
    fields:
      - name: x
        type: slice
      - name: y
        type: slice
  - name: dual_inner_prod_c
    fields:
      - name: x
        type: slice
      - name: y01
        type: slice
      - name: y02
        type: slice
  - name: stereo_merge
    fields:
      - name: X
        type: slice
      - name: Y
        type: slice
  - name: opus_encode_native
    fields:
      - name: pcm
        type: slice
      - name: data
        type: slice
  - name: ec_dec_icdf
    fields:
      - name: _icdf
        type: slice
  - name: ec_enc_icdf
    fields:
      - name: _icdf
        type: slice
  - name: silk_Decode
    fields:
      - name: samplesOut
        type: slice
  - name: combine_pulses
    fields:
      - name: out
        type: slice
      - name: in
        type: slice
  - name: encode_split
    fields:
      - name: shell_table
        type: slice
  - name: decode_split
    fields:
      - name: shell_table
        type: slice
  - name: silk_shell_encoder
    fields:
      - name: pulses0
        type: slice
  - name: silk_shell_decoder
    fields:
      - name: pulses0
        type: slice
  - name: combine_and_check
    fields:
      - name: pulses_comb
        type: slice
      - name: pulses_in
        type: slice
  - name: silk_bwexpander
    fields:
      - name: ar
        type: slice
  - name: silk_bwexpander_32
    fields:
      - name: ar
        type: slice
  - name: silk_NLSF_decode
    fields:
      - name: pNLSF_Q15
        type: slice
      - name: NLSFIndices
        type: slice
  - name: silk_NLSF_stabilize
    fields:
      - name: NLSF_Q15
        type: slice
      - name: NDeltaMin_Q15
        type: slice
  - name: silk_insertion_sort_increasing_all_values_int16
    fields:
      - name: a
        type: slice
  - name: silk_insertion_sort_increasing
    fields:
      - name: a
        type: slice
      - name: idx
        type: slice
  - name: silk_NLSF2A_find_poly
    fields:
      - name: out
        type: slice
      - name: cLSF
        type: slice
  - name: silk_NLSF2A
    fields:
      - name: a_Q12
        type: slice
      - name: NLSF
        type: slice
  - name: silk_LPC_fit
    fields:
      - name: a_QOUT
        type: slice
      - name: a_QIN
        type: slice
  - name: silk_LPC_inverse_pred_gain_c
    fields:
      - name: A_Q12
        type: slice
  - name: silk_LPC_analysis_filter
    fields:
      - name: out
        type: slice
      - name: in
        type: slice
      - name: B
        type: slice
  - name: silk_sum_sqr_shift
    fields:
      - name: x
        type: slice
  - name: silk_PLC_energy
    fields:
      - name: exc_Q14
        type: slice
      - name: prevGain_Q10
        type: slice
  - name: silk_resampler_private_up2_HQ
    fields:
      - name: S
        type: slice
      - name: out
        type: slice
      - name: in
        type: slice
  - name: silk_resampler_private_up2_HQ_wrapper
    fields:
      - name: out
        type: slice
      - name: in
        type: slice
  - name: silk_resampler_private_IIR_FIR_INTERPOL
    fields:
      - name: out
        type: slice
      - name: buf
        type: slice
      - name: return
        type: slice
  - name: silk_resampler_private_down_FIR_INTERPOL
    fields:
      - name: out
        type: slice
      - name: buf
        type: slice
      - name: FIR_Coefs
        type: slice
      - name: return
        type: slice
  - name: silk_ana_filt_bank_1
    fields:
      - name: in
        type: slice
      - name: S
        type: slice
      - name: outL
        type: slice
      - name: outH
        type: slice
  - name: silk_float2short_array
    fields:
      - name: in
        type: slice
      - name: out
        type: slice
  - name: silk_short2float_array
    fields:
      - name: in
        type: slice
      - name: out
        type: slice
src_files:
  - name: include/opus_types.h
    content: |
      #ifndef OPUS_TYPES_H
      #define OPUS_TYPES_H
      #include <stdint.h>
      
      #define opus_int         int
      #define opus_uint        unsigned int
      #define opus_int8        int8_t
      #define opus_int16       int16_t
      #define opus_int32       int32_t
      #define opus_int64       int64_t
      #define opus_uint8       uint8_t
      #define opus_uint16      uint16_t
      #define opus_uint32      uint32_t
      #define opus_uint64      uint64_t
      
      #endif // OPUS_TYPES_H
files:
  - name: src/tansig_table.h
  - name: src/opus_private.h
  - name: include/opus_defines.h
  - name: src/analysis.c
  - name: src/mlp.c
  - name: src/mlp_data.c
  - name: src/opus.c
  - name: src/opus_decoder.c
  - name: src/opus_encoder.c
  - name: src/repacketizer.c

  # ==== SILK ====
  - name: silk/macros.h
  - name: silk/define.h
    replace:
      - old: 'uint8 = math.MaxUint8'
        new: '= math.MaxUint8'
  - name: silk/errors.h
#  - name: silk/structs.h # DONE
  - name: silk/typedef.h
    replace:
      - old: 'uint32 ='
        new: '='
      - old: 'uint16 ='
        new: '='
      - old: 'uint8 ='
        new: '='
  - name: silk/tuning_parameters.h
  - name: silk/pitch_est_defines.h
  - name: silk/resampler_private.h
#  - name: silk/resampler_structs.h # DONE
  - name: silk/float/SigProc_FLP.h
  - name: silk/SigProc_FIX.h
  - name: silk/Inlines.h
    predef: |
      #include <stdint.h>
      #include "opus_types.h"
      #include "SigProc_FIX.h"
      #define silk_int32_MAX INT32_MAX
      #define OPUS_INLINE
  - name: silk/NLSF2A.c
    replace:
      - old: QA
        new: NLSF2A_QA
  - name: silk/NLSF_unpack.c
    disabled: true # DONE
  - name: silk/stereo_decode_pred.c
    disabled: true # DONE
  - name: silk/decode_indices.c
    disabled: true # DONE
  - name: silk/code_signs.c
    disabled: true # DONE
  - name: silk/decode_pulses.c
    disabled: true # DONE
  - name: silk/encode_pulses.c
    disabled: true # DONE
  - name: silk/shell_coder.c
    disabled: true # DONE
  - name: silk/gain_quant.c
    disabled: true # DONE
  - name: silk/bwexpander.c
    disabled: true # DONE
  - name: silk/bwexpander_32.c
    disabled: true # DONE
  - name: silk/NLSF_decode.c
    disabled: true # DONE
  - name: silk/NLSF_stabilize.c
    disabled: true # DONE
  - name: silk/NLSF2A.c
    disabled: true # DONE
  - name: silk/LPC_fit.c
    disabled: true # DONE
  - name: silk/decode_pitch.c
    disabled: true # DONE
  - name: silk/decode_core.c
    disabled: true # DONE
  - name: silk/decode_parameters.c
    disabled: true # DONE
  - name: silk/PLC.c
    disabled: true # DONE
  - name: silk/CNG.c
    disabled: true # DONE
  - name: silk/init_decoder.c
    disabled: true # DONE
  - name: silk/control.h
    disabled: true # DONE
  - name: silk/decode_frame.c
    disabled: true # DONE
  - name: silk/decode_frame.c
    disabled: true # DONE
  - name: silk/resampler_private_up2_HQ.c
    disabled: true # DONE
  - name: silk/resampler_private_IIR_FIR.c
    disabled: true # DONE
  - name: silk/resampler_private_AR2.c
    disabled: true # DONE
  - name: silk/resampler_private_down_FIR.c
    disabled: true # DONE
  - name: silk/resampler.c
    disabled: true # DONE
  - name: silk/decoder_set_fs.c
    disabled: true # DONE
  - name: silk/stereo_MS_to_LR.c
    disabled: true # DONE
  - name: silk/dec_API.c
    disabled: true # DONE
  - name: silk/check_control_input.c
    disabled: true # DONE
  - name: silk/float/structs_FLP.h
    disabled: true # DONE
  - name: silk/VAD.c
    disabled: true # DONE
  - name: silk/ana_filt_bank_1.c
    disabled: true # DONE
  - name: silk/sigm_Q15.c
    disabled: true # DONE
  - name: silk/init_encoder.c
    disabled: true # DONE

  - name: silk/*.c

  # ==== CELT ====
  - name: celt/arch.h
  - name: celt/entcode.c
    disabled: true # DONE
  - name: celt/entdec.c
    disabled: true # DONE
  - name: celt/entenc.c
    disabled: true # DONE
  - name: celt/mathops.c
    replace:
      - old: PI
        new: celtPI
  - name: celt/celt_encoder.c
    disabled: true # FIXME: if in for init incorrectly unwrapped
  - name: celt/opus_custom_demo.c
    disabled: true
  - name: celt/static_modes_float.h
    predef: |
      #include "opus_types.h"
      static const opus_int16 eband5ms[22];
      static const unsigned char band_allocation[231];
  - name: celt/quant_bands.c
    replace:
      - old: 'float64(1<<'
        new: 'float64(int64(1)<<'
  - name: celt/*.c
  # ==== Additional Go code ====
  - name: celt_mathops_const.go
    content: |
      package libopus
      
      const (
        cA = 0.43157974
        cB = 0.67848403
        cC = 0.08595542
        cE = float32(celtPI)/2
      )
  - name: hacks.go
    content: |
      package libopus
      
      func opus_select_arch() int { panic("TODO") }
  - name: types.go
    content: |
      package libopus
      
      const ALLOC_NONE = 1
      const CHAR_BIT = 8
  - name: opus_test.go
    content: |
      package libopus
      
      import "testing"
      
      func TestOpus(t *testing.T) {
      }
